{% load static %}
<html lang="en-JP">
<link href="{% static 'main/test.css' %}" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">


<body style="background-image: url('{% static 'main/WhatsApp画像 2024-02-14 13.27.37_9343389c.jpg' %}'); background-size: 100% 100%; background-position: center; background-repeat: no-repeat; margin: 0; padding: 0;">
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6" id="hiding">
        <div class="card mb-4">
        <div class="card-body">
            <a {% if user.is_authenticated %} href="{% url 'accounts:logout' %}?next={% url 'accounts:login' %}?next={% url 'main:profile' %}"
            {% else %} href="{% url 'accounts:login' %}?next={% url 'main:profile' %}"
            {% endif %} class="w-50 pl-3 pb-4">
            <div class="card border-0 border-bottom-blue shadow-lg shadow-hover">
            <div class="card-body text-center">
            <div class="text-center">
            </div>
            {% if user.is_authenticated %}
            Logout
            {% else %}
            Login
            {% endif %}
            </div>
            </div>
            </a>
            <button id="toggleFormBtn" class="btn btn-success mb-3" data-toggle="collapse" data-target="#signupForm">Create a new account!</button>
            <div class="collapse" id="signupForm">
                <form method="post">
                    {% csrf_token %}
                    {% for field in signup_form %}
                        <label class="text-dark font-weight-bold" for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                {% endfor %}
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-success btn-lg">Create!</button>
                </div>
                </form>
            </div>
            <form method="post" action="{% url 'main:profile' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="school_name">School Name:</label>
                    <input type="text" name="school_name" id="school_name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="school_password">Password:</label>
                    <input type="password" name="school_password" id="school_password" class="form-control">
                </div>
                <div class="form-group">
                    <label for="classroom_name">Classroom Name:</label>
                    <input type="text" name="classroom_name" id="classroom_name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="classroom_password">Classroom Password:</label>
                    <input type="password" name="classroom_password" id="classroom_password" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>


            {% for classroom in classrooms %}
                {% if classroom_name == classroom.name and classroom_password == classroom.hashed_password %}
                <h2>Click on a test to enter the classroom!</h2>
                {% endif %}
            {% endfor %}




            <div class="container mt-5" id="classroomList">
                {% for school in schools %}
                    {% if school.name == school_name and school.hashed_password == school_password %}
                        {% if classroom_name == '' and classroom_password == '' %}
                        <div>
                                <h5 class="card-title">Create Classroom</h5>
                                <form class="createClassroomForm" method="post" action="{% url 'main:classroom_create' school.pk %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    {% for field in classroom_form %}
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                    {% endfor %}
                                    <button type="submit" class="btn btn-success">Create Classroom</button>
                                </form>
                        </div>
                        {% endif %}

                        {% for classroom in classrooms %}
                            {% if classroom.school.name == school_name and classroom.school.hashed_password == school_password %}
                            {% if classroom.name == classroom_name and classroom.hashed_password == classroom_password %}
                            <div>
                                        <h5 class="card-title">Create Test</h5>
                                        <form class="createTestForm" method="post" action="{% url 'main:test_create' classroom.pk %}" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            {% for field in test_form %}
                                                <div class="form-group">
                                                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                    {{ field }}
                                                </div>
                                            {% endfor %}
                                            <button type="submit" class="btn btn-success">Create Test</button>
                                        </form>
                            </div>
                            <h3>Current tests!</h3>
                            {% for test in tests %}
                            {% if test.classroom == classroom %}
                            <button id="toggleFormBtn" class="btn btn-primary mb-3" data-toggle="collapse" data-target="#{{ test.pk }}Content">{{ test.name }}</button>
                            <div class="collapse" id="{{ test.pk }}Content">
                                {% if test.test_picture %}
                                <img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:test_picture' test.id %}" alt="Lesson">
                                {% endif %}
                                    <h5 class="card-title">Create Question</h5>
                                    <form class="createQuestionForm" method="post" action="{% url 'main:question_create' test.pk %}" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        {% for field in question_form %}
                                            <div class="form-group">
                                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                {{ field }}
                                            </div>
                                        {% endfor %}
                                        <button type="submit" class="btn btn-success">Create Question</button>
                                    </form>
                            <h3>Current Questions!</h3>
                            <div class="question-container"></div>
                            {% for question in questions %}
                            {% if question.test == test %}
                                <button id="toggleFormBtn" class="btn btn-primary mb-3" data-toggle="collapse" data-target="#{{ test.name }}{{ question.pk }}Content">{{ question.name }}</button>
                                <div class="collapse" id="{{ test.name }}{{ question.pk }}Content">
                                {% if question.question_picture %}
                                <img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:question_picture' question.id %}" alt="Lesson">
                                {% endif %}
                                    <h5 class="card-title">Create Option</h5>
                                    <form class="createOptionForm" method="post" action="{% url 'main:option_create' question.pk %}" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        {% for field in option_form %}
                                            <div class="form-group">
                                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                {{ field }}
                                            </div>
                                        {% endfor %}
                                        <button type="submit" class="btn btn-success">Create Option</button>
                                    </form>
                                    <h3>Current options</h3>
                                    <div class="option-container"></div>
                                    {% for option in options %}
                                    {% if option.question == question %}
                                    <div>{{ option.name }}</div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% endfor %}
                            <h2>Remaining tests!</h2>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        </div>
        </div>

        <div class="col-md-6" id="change">
            <div class="quiz-container d-flex justify-content-center align-items-center" id="quiz">
                <div class="quiz-header">
                    {% for classroom in classrooms %}
                    {% if classroom_name == classroom.name and classroom_password == classroom.hashed_password %}
                    <h2>You are in the Classroom: {{ classroom.name }}{% if classroom.classroom_picture %}<img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:classroom_picture' classroom.id %}" alt="Question">{% endif %}</h2>
                    {% for test in tests %}
                    {% if test.classroom == classroom %}
                    <button id="toggleFormBtn{{ test.pk }}" class="btn btn-dark mb-3" style="width: 400px; height: 120px;" data-toggle="collapse" data-target="#test{{ test.pk }}Content">
                        {{ test.name }}{% if test.test_picture %}<img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:test_picture' test.id %}" alt="Test">
                        {% endif %}
                    </button>
                    <div class="collapse" id="test{{ test.pk }}Content">
                        {{ test.name }}
                        <div class="message"></div>
                        <div id="completion-message"></div>
                        {% for question in questions %}
                        {% if question.test == test %}
                        <div class="question" id="question{{ question.id }}" style="display: {% if forloop.first %}block{% else %}none{% endif %}">
                            <h2>{{ question }}{% if question.question_picture %}<img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:question_picture' question.id %}" alt="Question">{% endif %}</h2>
                            {% if question.question_sound %}
                            <audio controls>
                                <source src="{% url 'main:question_sound' question.id %}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                            {% endif %}
                            <ul class="list-unstyled">
                                <form class="test-form" method="post" action="{% url 'main:test_submit' test.pk %}" onsubmit="submitForm({{ question.id }})">
                                    {% csrf_token %}
                                    <div class="container-fluid">
                                    <div class="row">
                                    {% for option in options %}
                                    {% if option.question == question %}
                                    <div class="col-md-6">
                                            {% for field in test_submission_form %}
                                            {% for choice in field %}
                                            {% if choice.choice_label == option.name %}
                                                {% if option.option_picture %}<img style="width:100px;height:100px;margin-top: 8px; border:3px solid black;" src="{% url 'main:option_picture' option.id %}" alt="Option">
                                                {% endif %}
                                                <label>{{ choice }}</label>
                                            {% endif %}
                                            {% endfor %}
                                            {% endfor %}
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                    </div>
                                    </div>
                                    <button id="submit-btn" type="submit" onclick="submitForm({{ question.id }})">Submit answer for {{ question.name }}</button>
                                </form>
                            </ul>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="{% static 'main/test_submit.js'%}?v=3"></script>
<script src="{% static 'main/next_questions.js'%}"></script>



<script>
    $(document).ready(function() {
        $('.btn').click(function() {
            var btnId = $(this).attr('id');
            var testId = btnId.replace('toggleFormBtn', '');
            var contentId = '#test' + testId + 'Content';
            var colDiv = $('#change');
            if (colDiv.hasClass('col-md-6')) {
                colDiv.removeClass('col-md-6').addClass('col-md-12');
            } else {
                colDiv.removeClass('col-md-12').addClass('col-md-6');
            }
            $(contentId).collapse('toggle');
        });
    });
</script>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        var toggleButtons = document.querySelectorAll('.btn.btn-dark.mb-3');

        toggleButtons.forEach(function(toggleButton) {
            toggleButton.addEventListener('click', function() {
                var targetArea = document.getElementById('hiding'); // Select the area with the ID 'hiding'
                if (targetArea.style.display === 'none') {
                    targetArea.style.display = 'block';
                } else {
                    targetArea.style.display = 'none';
                }
            });
        });
    });
</script>







<script>
    document.addEventListener('DOMContentLoaded', function() {
        var testButtons = document.querySelectorAll('.btn.btn-dark.mb-3');
        testButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var testContent = button.nextElementSibling;
                var firstQuestion = testContent.querySelector('.question');
                firstQuestion.style.display = 'block';
                var otherQuestions = testContent.querySelectorAll('.question:not(#' + firstQuestion.id + ')');
                otherQuestions.forEach(function(question) {
                    question.style.display = 'none';
                });

                testButtons.forEach(function(otherButton) {
                    if (otherButton !== button) {
                        if (otherButton.style.display === 'none') {
                            otherButton.style.display = 'block';
                        } else {
                            otherButton.style.display = 'none';
                        }
                    }
                });
            });
        });
    });
</script>












<script>
document.addEventListener('DOMContentLoaded', function() {
    var testButtons = document.querySelectorAll('.btn.btn-dark.mb-3');
    testButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var testContent = button.nextElementSibling;
            var firstQuestion = testContent.querySelector('.question');
            firstQuestion.style.display = 'block';
            var otherQuestions = testContent.querySelectorAll('.question:not(#' + firstQuestion.id + ')');
            otherQuestions.forEach(function(question) {
                question.style.display = 'none';
            });
        });
    });
});
</script>

<script>
$('.createQuestionForm').submit(function (e) {
    e.preventDefault();

    var form = $(this);
    var formData = new FormData(form[0]);

    formData.delete('csrfmiddlewaretoken');
    var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
    formData.append('csrfmiddlewaretoken', csrfToken);

    var url = form.attr('action');

    $.ajax({
        type: form.attr('method'),
        url: url,
        data: formData,
        processData: false,
        contentType: false,
        success: function (data) {
            console.log(data);

            if (data.success) {
                var questionContainer = $('.question-container'); // Selecting the container directly

                var newQuestionButton =
                    '<button class="btn btn-primary mb-3 toggle-form-btn" data-toggle="collapse" data-target="#' + data.pk + 'Content">' +
                    'Newly Created Question: ' + data.name +
                    '</button>' +
                    '<div class="collapse" id="' + data.pk + 'Content">' +
                    '<h5 class="card-title">Create Option</h5>' +
                    '<form class="createOptionForm" method="post" action="{% url 'main:option_create' 0 %}" enctype="multipart/form-data">' +
                    '{% csrf_token %}' +
                    '<input type="hidden" name="question_pk" value="' + data.pk + '">' + // Include question PK in the form
                    '<div class="form-group">' +
                    '<label for="option_name">Option Name</label>' +
                    '<input type="text" id="option_name" name="name" class="form-control" required>' +
                    '</div>' +
                    '<button type="submit" class="btn btn-success">Create Option</button>' +
                    '</form>' +
                    '<h3>Current options</h3>' +
                    '<div class="option-container"></div>' +
                    '</div>';

                newQuestionButton = newQuestionButton.replace('{% url 'main:option_create' 0 %}', '/option/' + data.pk + '/create/');


                $('.question-container').append(newQuestionButton);

                // Add an event listener if needed
                newQuestionButton.on('click', function () {
                    // Handle button click event if needed
                });

                form.trigger('reset');
            } else {
                // Handle errors if necessary
            }
        },
        error: function (xhr, status, error) {
            console.log('Error:', xhr.responseJSON);
            alert('An error occurred: ' + xhr.statusText);
        }
    });
});
</script>

<script>
$('.createOptionForm').submit(function (e) {
    e.preventDefault();

    var form = $(this);
    var formData = new FormData(form[0]);

    formData.delete('csrfmiddlewaretoken');
    var csrfToken = $('input[name=csrfmiddlewaretoken]').val();
    formData.append('csrfmiddlewaretoken', csrfToken);

    var url = form.attr('action');

    $.ajax({
        type: form.attr('method'),
        url: url,
        data: formData,
        processData: false,
        contentType: false,
        success: function (data) {
            console.log(data);

            if (data.success) {
                var optionContainer = form.siblings('.option-container'); // Selecting the container directly

                // Append the newly created option to the option container
                var newOption = '<div id="add_options">' + data.name + '</div>';
                optionContainer.append(newOption);

                form.trigger('reset');
            } else {
                // Handle errors if necessary
            }
        },
        error: function (xhr, status, error) {
            console.log('Error:', xhr.responseJSON);
            alert('An error occurred: ' + xhr.statusText);
        }
    });
});

</script>

